pipeline {
    agent {
        //Use high performance node in GCP to build, test and deploy project
        label 'gcp_node'
    }

    environment {
        //Pass in environmental variables
        //The credentials are stored in Jenkins credentials
        DB_URL = credentials('RICHARD_PROD_DB_URL')
        DB_USERNAME = credentials('RICHARD_PROD_DB_USERNAME')
        DB_PASSWORD = credentials('RICHARD_PROD_DB_PASSWORD')
        ECR_TOKEN = credentials('RICHARD_PROD_ECR_TOKEN')
        ECR_REPO_NAME = credentials('RICHARD_PROD_ECR_NAME')
        ECS_CLUSTER_NAME = credentials('RICHARD_PROD_ECS_CLUSTER')
        ECS_SERVICE_NAME = credentials('RICHARD_PROD_ECS_SERVICE')
    }

    stages {
        stage('Git checkout') {
            steps {
                //Get the source code to workspace
                echo 'Getting the source code...'
                git branch: 'devops-richard',
                url: 'https://github.com/The-Avengers-Gamera/gamera-be.git'
            }
        }

        stage('Test') {
            steps {
                //Unit test to check if testcases can be passed
                echo 'Testing...'
                sh './gradlew clean test'
            }
        }

        stage('Build') {
            steps {
                //Build the project
                echo 'Building project...'
                sh './gradlew build'
            }
        }
        
        stage('Approval and deploy') {
            steps {
                echo 'Deploying...'

                //Prompt manual confirm process before deploying the project
                timeout(time:15, unit:'MINUTES'){
                    input(
                        message:"Are you sure to deploy to production environment?"
                        ok: "YES"
                    )
                }
                
                //Generate docker image from Dockerfile
                sh 'sudo docker build --build-arg DB_URL=${DB_URL} \
                    --build-arg DB_USERNAME=${DB_USERNAME} \
                    --build-arg DB_PASSWORD=${DB_PASSWORD} -t gamera-service .'

                //Authenticate Docker client to ECR repository
                sh 'aws ecr get-login-password --region ap-southeast-2 | docker login \
                    --username AWS --password-stdin ${ECR_TOKEN}'

                //Tag the docker built, one for version tag, one for latest tag
                sh 'docker tag gamera-service ${ECR_TOKEN}/${ECR_REPO_NAME}:${BUILD_NUMBER}'
                sh 'docker tag gamera-service ${ECR_TOKEN}/${ECR_REPO_NAME}:latest'

                //push the Dockerfile to ECR
                sh 'docker push ${ECR_TOKEN}/${ECR_REPO_NAME}:${BUILD_NUMBER}'
                sh 'docker push ${ECR_TOKEN}/${ECR_REPO_NAME}:latest'

                //Redeploy the service to ECS cluster with new task defination
                sh 'aws ecs update-service --cluster ${ECS_CLUSTER_NAME} \
                    --service ${ECS_SERVICE_NAME} --force-new-deployment'
            }
        }
    }

    post {
        always {
            //Clean the workspace after every pipeline build process
            echo 'Cleaning workspace'
            sh 'docker images gamera-service -q | xargs docker image rm -f'
            cleanWs()
        }

        failure {
            echo 'Build fail, sending error message for debugging'

            // Send error messages to DevOps engineer for debugging
            mail to: 'yyaug99@gmail.com',
            subject: "Pipeline build fails in: ${currentBuild.fullDisplayName}",
            body: "Build failed in ${env.BUILD_URL}"
        }
    }
}
